<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>d2 Attention Test</title>
    <link rel="stylesheet" href="./src/external/material-components-web/material-components-web.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="./src/css/master.css?v=13" type="text/css" />

    <link rel="apple-touch-icon" sizes="57x57" href="./src/icon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./src/icon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./src/icon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./src/icon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./src/icon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./src/icon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./src/icon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./src/icon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./src/icon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="./src/icon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./src/icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./src/icon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./src/icon/favicon-16x16.png">
    <link rel="manifest" href="./src/icon/manifest.json">
    <meta name="msapplication-TileColor" content="#191919">
    <meta name="msapplication-TileImage" content="./src/icon/ms-icon-144x144.png">
    <meta name="theme-color" content="#191919">
  </head>
  <body class="mdc-typography">

    <!-- Firebase status -->
    <i class="firebase-status material-icons">cloud_queue</i>
    <div class="firebase-console" style="display: none;">
      <div class="firebase-userpanel" style="display: none;">
        <h1 class="mdc-typography--subheading1">Firebase Status:</h1>
        <table>
          <tr>
            <td><b>E-mail&nbsp;</b></td><td class="firebase-email"></td>
          </tr>
          <tr>
            <td><b>UID</b></td><td class="firebase-uid"></td>
          </tr>
        </table><br>
        <button id="signOut" type="button" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Sign Out</button>
      </div>
      <div class="firebase-signinpanel">
        <button signin="google" type="button" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Sign In With Google</button><br><br>
        <button signin="anon" type="button" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Sign In Anonymously</button>
      </div>
    </div>

    <!-- Main Content -->
    <main id="setup">
      <div class="mdc-elevation--z3" style="margin: 50px auto; max-width: 500px; padding: 10px; text-align: center; background-color: #FAFAFA;">
        <h1 class="mdc-typography--title">d2 Attention Test <i id="settings-btn" class="material-icons" style="float: right; cursor: pointer;">settings</i></h1>
        <hr>
        <div id="settings-div" style="display: none;">
          <div>
            <h1 class="mdc-typography--subheading1">Letters:</h1>
            <table style="margin: 0 auto;">
              <thead>
                <th>Letter</th><th>Enabled</th><th>Correct</th><th>Stripes</th><th>Remove</th>
              </thead>
              <tbody id="lettertable"></tbody>
            </table>
            <button type="button" onclick="(new Letter()).add()" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Add Letter</button>
            <br>
            <hr>
            <h1 class="mdc-typography--subheading2">Stripe Variation:</h1>
            <h1 class="mdc-typography--body1" style="text-align: left;">Top stripes:</h1>
            <div id="stripeslider-top" class="mdc-slider mdc-slider--discrete" tabindex="0" role="slider" aria-valuemin="0" aria-valuemax="5" aria-valuenow="3" aria-label="Stripes Top">
              <div class="mdc-slider__track-container">
                <div class="mdc-slider__track"></div>
              </div>
              <div class="mdc-slider__thumb-container">
                <div class="mdc-slider__pin">
                  <span class="mdc-slider__pin-value-marker"></span>
                </div>
                <svg class="mdc-slider__thumb" width="21" height="21">
                  <circle cx="10.5" cy="10.5" r="7.875"></circle>
                </svg>
                <div class="mdc-slider__focus-ring"></div>
              </div>
            </div>
            <h1 class="mdc-typography--body1" style="text-align: left;">Bottom stripes:</h1>
            <div id="stripeslider-bottom" class="mdc-slider mdc-slider--discrete" tabindex="0" role="slider" aria-valuemin="0" aria-valuemax="5" aria-valuenow="3" aria-label="Stripes Top">
              <div class="mdc-slider__track-container">
                <div class="mdc-slider__track"></div>
              </div>
              <div class="mdc-slider__thumb-container">
                <div class="mdc-slider__pin">
                  <span class="mdc-slider__pin-value-marker"></span>
                </div>
                <svg class="mdc-slider__thumb" width="21" height="21">
                  <circle cx="10.5" cy="10.5" r="7.875"></circle>
                </svg>
                <div class="mdc-slider__focus-ring"></div>
              </div>
            </div>
            <br>
            <hr>
            <h1 class="mdc-typography--subheading2">Correct ratio:</h1>
            <div id="correctslider" class="mdc-slider mdc-slider--discrete" tabindex="0" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="45" aria-label="Correct ratio">
              <div class="mdc-slider__track-container" style="background-color: darkRed;">
                <div class="mdc-slider__track" style="background-color: darkGreen;"></div>
              </div>
              <div class="mdc-slider__thumb-container">
                <div class="mdc-slider__pin">
                  <span class="mdc-slider__pin-value-marker"></span>
                </div>
                <svg class="mdc-slider__thumb" width="21" height="21">
                  <circle cx="10.5" cy="10.5" r="7.875"></circle>
                </svg>
                <div class="mdc-slider__focus-ring"></div>
              </div>
            </div>
            <br>
            <hr>
            <h1 class="mdc-typography--subheading2">Screens:</h1>
            <div class="mdc-textfield" data-mdc-auto-init="MDCTextfield">
              <input type="number" class="mdc-textfield__input" min="1" max="100" value="14" id="screennumber" />
              <label for="screennumber" class="mdc-textfield__label">Number of screens</label>
            </div><br>
            <div class="mdc-textfield" data-mdc-auto-init="MDCTextfield">
              <input type="number" class="mdc-textfield__input" min="1" max="100" value="6" id="rownumber" />
              <label for="rownumber" class="mdc-textfield__label">Number of rows</label>
            </div><br>
            <div class="mdc-textfield" data-mdc-auto-init="MDCTextfield">
              <input type="number" class="mdc-textfield__input" min="1" max="100" value="10" id="columnnumber" />
              <label for="columnnumber" class="mdc-textfield__label">Number of columns</label>
            </div>
          </div>
          <hr>
        </div>
        <button type="button" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" onclick="switchMain('test0')" data-mdc-auto-init="MDCRipple">Start</button>
      </div>
    </main>

    <main id="test0" style="color: white; text-align: center; display: none;">
      <h1 class="mdc-typography--display1">The d2 test works as following:</h1>
      <p class="mdc-typography--body2">
        When the test starts a screen with letters will be shown.<br>
        Each letter can have multiple vertical lines above or below them.<br>
        You can mark a letter by clicking on them.<br>
        The following letters should be marked:<br>
        <ul id="correcttable"></ul><br>
        Your goal is to mark as many (of the above named cases) as possible.<br>
        For each screen you'll get 20 seconds.<br><br>
        <button type="button" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="switchMain('test1')">Start the test</button><br><br>
        <button type="button" class="mdc-button mdc-button--raised mdc-button--accent mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="switchMain('setup')">Return to Start</button>
      </p>
    </main>

    <main id="test1" style="display: none;">
      <div class="testbox" style="margin-top: 15%;">

      </div>
      <div id="progress">
        <div id="progress-bar"></div>
      </div>
    </main>

    <main id="testend" style="margin: 50px auto; max-width: 500px; padding: 10px; text-align: center; background-color: #FAFAFA; display: none;">
      <h1 class="mdc-typography--title">The End</h1>
      <p class="mdc-typography--body1">You've reached the end of the test.<br>Thank you very much for participating and well done.</p>
      <hr>
      <h1 class="mdc-typography--subheading1">Results</h1>
      <table style="width: 100%;">
        <thead>
          <th>Context</th><th>Concentration Score</th><th>Processing Speed</th><th>Error Rate</th>
        </thead>
        <tbody id="resultstable">

        </tbody>
      </table>
      <hr>
      <canvas id="resultCanvas"></canvas>
      <hr>
      <button type="button" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="document.location.href = document.location.href">Return to Start</button>
    </main>

    <!-- Scripts -->
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/4.4.0/firebase.js"></script>
    <script type="text/javascript" src="./src/external/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="./src/external/material-components-web/material-components-web.min.js"></script>
    <!-- <script type="text/javascript" src="./src/external/mousetrap/mousetrap.min.js"></script> -->
    <script type="text/javascript" src="./src/js/d2.js"></script>
    <script type="text/javascript" src="./src/js/results.js"></script>
    <script type="text/javascript">
        /* global $, mdc, auth, signIn, Test */
        let letterlist = []
        let letters = {}
        let test
        let topslider = new mdc.slider.MDCSlider($('#stripeslider-top')[0])
        let bottomslider = new mdc.slider.MDCSlider($('#stripeslider-bottom')[0])
        let correctslider = new mdc.slider.MDCSlider($('#correctslider')[0])

        function switchMain (name) {
          $('#' + name).trigger('mainswitch')
          $('main').hide()
          $('#' + name).show()
        }

        function Letter () {
          this.idn = Math.floor(Math.random() * 1000)
          this.letter = null
          this.enabled = true
          this.correct = false
          this.stripes = 2
          this.locked = false

          this.add = (opts) => {
            if (typeof opts === 'undefined') opts = {}
            if (typeof opts.letter === 'string') this.letter = opts.letter
            if (typeof opts.enabled === 'boolean') this.enabled = opts.enabled
            if (typeof opts.correct === 'boolean') this.correct = opts.correct
            if (typeof opts.stripes === 'number') this.stripes = opts.stripes
            if (typeof opts.locked === 'boolean') this.locked = opts.locked
            $('#lettertable').append('<tr name="' + this.idn + '-row"><td><input type="text" class="mdc-textfield__input input-char" name="' + this.idn + '-letter" placeholder="letter" ' + (typeof opts.letter === 'string' ? 'value="' + this.letter + '" ' : '') + (this.locked ? 'disabled ' : '') + '/></td><td><div class="mdc-switch' + (this.locked ? ' mdc-switch--disabled' : '') + '"><input type="checkbox" name="' + this.idn + '-enabled" class="mdc-switch__native-control" ' + (this.enabled ? 'checked ' : '') + (this.locked ? 'disabled ' : '') + '/><div class="mdc-switch__background"><div class="mdc-switch__knob"></div></div></div></td><td><div class="mdc-switch' + (this.locked ? ' mdc-switch--disabled' : '') + '"><input type="checkbox" name="' + this.idn + '-correct" class="mdc-switch__native-control" ' + (this.correct ? 'checked ' : '') + (this.locked ? 'disabled ' : '') + '/><div class="mdc-switch__background"><div class="mdc-switch__knob"></div></div></div></td><td><input type="number" class="mdc-textfield__input input-number" name="' + this.idn + '-stripes" placeholder="stripes" value="' + (typeof opts.stripes === 'number' ? opts.stripes : '') + '" ' + (this.correct ? '' : 'disabled ') + (this.locked ? 'disabled ' : '') + '/></td><td><i class="material-icons" name="' + this.idn + '-remove" style="cursor: pointer;">' + (this.locked ? 'lock' : 'remove_circle') + '</i></td></tr>')
            $('[name="' + this.idn + '-letter"]').change(_ => {
              if ($('[name="' + this.idn + '-letter"]').val().length > 1) {
                $('[name="' + this.idn + '-letter"]').val($('[name="' + this.idn + '-letter"]').val()[0])
                this.letter = $('[name="' + this.idn + '-letter"]').val()
              } else if ($('[name="' + this.idn + '-letter"]').val().length === 1) {
                this.letter = $('[name="' + this.idn + '-letter"]').val()
              }
            })
            $('[name="' + this.idn + '-enabled"]').change(_ => {
              this.enabled = $('[name="' + this.idn + '-enabled"]').is(':checked')
            })
            $('[name="' + this.idn + '-correct"]').change(_ => {
              if ($('[name="' + this.idn + '-correct"]').is(':checked')) {
                this.correct = true
                $('[name="' + this.idn + '-stripes"]').attr('disabled', false)
              } else {
                this.correct = false
                $('[name="' + this.idn + '-stripes"]').attr('disabled', true)
              }
            })
            $('[name="' + this.idn + '-stripes"]').change(_ => {
              this.stripes = parseInt($('[name="' + this.idn + '-stripes"]').val(), 10)
            })
            $('[name="' + this.idn + '-remove"]').click(_ => {
              if (!this.locked) {
                let idr = parseInt($('[name="' + this.idn + '-remove"]').attr('name').split('-')[0], 10)
                letters[idr].remove()
              }
            })
          }
          this.remove = _ => {
            $('[name="' + this.idn + '-letter"]', '[name="' + this.idn + '-enabled"]', '[name="' + this.idn + '-correct"]', '[name="' + this.idn + '-remove"]').off()
            $('[name="' + this.idn + '-row"]').slideUp(200, function () { $(this).remove() })
            letterlist.splice(letterlist.indexOf(this.idn), 1)
            delete letters[this.idn]
          }

          while (letterlist.indexOf(this.idn) !== -1) {
            this.idn++
            if (this.idn > 1000) this.idn = 1
          }
          letterlist.push(this.idn)
          letters[this.idn] = this
          return this.idn
        }

        $(document).ready(_ => {
          mdc.autoInit()
          let l = [new Letter(), new Letter()]
          l[0].add({letter: 'd', enabled: true, correct: true, stripes: 2, locked: true})
          l[1].add({letter: 'p', enabled: true, correct: false, locked: true})
          if (auth.currentUser == null) signIn()

          $('#settings-btn').click(_ => {
            $('#settings-div').slideToggle(200)
            topslider.layout()
            bottomslider.layout()
            correctslider.layout()
          })

          $('#test0').on('mainswitch', _ => {
            $('#correcttable').empty()
            Object.keys(letters).forEach((key) => {
              let letter = letters[key]
              if (letter.enabled && letter.correct) {
                $('#correcttable').append(`<li>The letter '${letter.letter}' with ${letter.stripes} vertical lines (in total).</li>`)
              }
            })
            test = new Test()
          })

          $('#test1').on('mainswitch', _ => {
            test.start()
          })
        })

        if (switchMain) {}
    </script>
  </body>
</html>
